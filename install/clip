#!/bin/bash

. `dirname "$0"`/../scripts/.helpers.sh

dest=$PREFIX/bin/clip

if [[ `uname` = Darwin ]]; then

  script $dest <<'CLIP'
#!/bin/sh
# generated
cmd=pbcopy
test -t 0 && cmd=pbpaste
exec $cmd
CLIP

else

  if ! have xsel; then
    if have apt-get; then
      sudo apt-get install xsel
    elif have pacman; then
      sudo pacman -S --needed xsel
    else
      warn 'unknown package management system'
    fi
  fi

  script "$dest" <<'CLIP'
#!/bin/sh
# generated

tmux-paste () {
  tmux load-buffer -w -
}

osc52 () {
  printf "\033]52;c;%s\007" "$(cat | base64 -w 0)"
}

x () {
  # xclip -selection clipboard "$@"
  xsel -b "$@"
}

clip () {
  # Copy to system clipboard.
  DISPLAY=${DISPLAY:-:0.0} x "$@"

  # If we just copied something to the system clipboard
  # but we are connected via SSH copy that to the terminal host.
  if [[ "-i" == "$1" ]] && [[ -z "$DISPLAY" ]] && [[ -n "$SSH_CONNECTION" ]]; then
    cmd=osc52
    [[ -n "$TMUX" ]] && cmd=tmux-paste
    clip -o | $cmd
  fi
}

if test -t 0; then
  clip -o
else
  clip -i
fi
CLIP


fi
